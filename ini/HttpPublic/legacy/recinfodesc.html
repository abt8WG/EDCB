dofile(mg.script_name:gsub('[^\\/]*$','')..'util.lua')

ct=[=[
<!doctype html><html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>EpgTimer</title>
</head>
<body>
録画済み詳細<br><br>
]=]

id=tonumber(mg.get_var(mg.request_info.query_string,'id')) or 0
w=edcb.GetRecFileInfo(id)
edcb.htmlEscape=15
v=edcb.GetRecFileInfo(id)
if v then
  if w and NativeToDocumentPath(w.recFilePath) then
    for i,ext in ipairs({'.webm',''}) do
      edcb.htmlEscape=0
      f=io.open(edcb.Convert('cp932', 'utf-8', w.recFilePath..ext), 'rb')
      edcb.htmlEscape=15
      if f then
        f:close()
        video=PathToRoot()..NativeToDocumentPath(w.recFilePath)..ext
        break
      end
    end
  end
  ct=ct..os.date('%Y/%m/%d(%a) %H:%M～', os.time(v.startTime))..os.date('%H:%M ', os.time(v.startTime)+v.durationSecond)..v.serviceName..'<br>\n'..v.title..'<br><br>\n'
    ..'結果：'..v.comment..'<br>\nドロップ：'..v.drops..'<br>\nスクランブル：'..v.scrambles..'<br><br>\n'
    ..(video and '<a href="'..mg.url_encode(video):gsub('%%2f','/')..'">'..edcb.Convert('utf-8', 'utf-8', video)..'</a> [<a href="'
       ..mg.url_encode(video:gsub('[^\\/]*$','')..'chunk.lua'):gsub('%%2f','/')..'?0='..mg.url_encode(video:match('[^\\/]*$'))..'">chunk.lua</a>]<br><br>\n' or '')
    ..'<hr>番組情報<hr>\n'..string.gsub(v.programInfo, '\r?\n', '<br>\n')
    ..'<hr>エラーログ<hr>\n'..string.gsub(v.errInfo, '\r?\n', '<br>\n')..'<br>\n'
    ..'<form method="POST" action="recinfodel.html?id='..v.id..'">\n'
    ..'<input type="hidden" name="ctok" value="'..CsrfToken()..'">\n'
    ..'<input type="submit" value="削除"></form>\n'
end

ct=ct..[=[
<a href="recinfo.html">録画済み一覧へ</a><br>
</body>
</html>
]=]
mg.write(Response(200, 'text/html', 'utf-8', #ct)..'\r\n', ct)
