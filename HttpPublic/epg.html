dofile(mg.document_root..'\\string.lua')

path='Setting\\HttpPublic.ini'
oneseg=0+edcb.GetPrivateProfile('GUIDE','oneseg',false,path)~=0
hover=0+edcb.GetPrivateProfile('GUIDE','hover',false,path)~=0
ONE_MIN_PX=edcb.GetPrivateProfile('GUIDE','ONE_MIN_PX','4',path)
MARGIN_HOUR=edcb.GetPrivateProfile('GUIDE','MARGIN_HOUR','1',path)
MARGIN_MIN=edcb.GetPrivateProfile('GUIDE','MARGIN_MIN','30',path)
w_service=edcb.GetPrivateProfile('GUIDE','service','208',path)
w_service_sp=edcb.GetPrivateProfile('GUIDE','service_sp','120',path)
w_hour=edcb.GetPrivateProfile('GUIDE','hour','22',path)
w_hour_sp=edcb.GetPrivateProfile('GUIDE','hour_sp','16',path)

background=edcb.GetPrivateProfile('BACKGROUND','background','#EEEEEE',path)

news=edcb.GetPrivateProfile('BACKGROUND','news','#B3E5FC',path)
sports=edcb.GetPrivateProfile('BACKGROUND','sports','#FFF9C4',path)
information=edcb.GetPrivateProfile('BACKGROUND','information','#BBDEFB',path)
drama=edcb.GetPrivateProfile('BACKGROUND','drama','#FFCDD2',path)
music=edcb.GetPrivateProfile('BACKGROUND','music','#FFECB3',path)
variety=edcb.GetPrivateProfile('BACKGROUND','variety','#E1BEE7',path)
movie=edcb.GetPrivateProfile('BACKGROUND','movie','#FFE0B2',path)
anime=edcb.GetPrivateProfile('BACKGROUND','anime','#F8BBD0',path)
documentary=edcb.GetPrivateProfile('BACKGROUND','documentary','#C5CAE9',path)
theater=edcb.GetPrivateProfile('BACKGROUND','theater','#DCEDC8',path)
education=edcb.GetPrivateProfile('BACKGROUND','education','#C8E6C9',path)
welfare=edcb.GetPrivateProfile('BACKGROUND','welfare','#B2DFDB',path)
extension=edcb.GetPrivateProfile('BACKGROUND','extension','#FFFFFF',path)
other=edcb.GetPrivateProfile('BACKGROUND','other','#F5F5F5',path)
none=edcb.GetPrivateProfile('BACKGROUND','none','#E0E0E0',path)
nothing=edcb.GetPrivateProfile('BACKGROUND','nothing','#9E9E9E',path)

reserved=edcb.GetPrivateProfile('BACKGROUND','reserved','#FF3D00',path)
disable=edcb.GetPrivateProfile('BACKGROUND','disable','#757575',path)
partially=edcb.GetPrivateProfile('BACKGROUND','partially','#FFFF00',path)
partially_border=edcb.GetPrivateProfile('BACKGROUND','partially_border','#FF3D00',path)
shortage=edcb.GetPrivateProfile('BACKGROUND','shortage','#FF5252',path)
shortage_border=edcb.GetPrivateProfile('BACKGROUND','shortage_border','#FFEA00',path)
paint=0+edcb.GetPrivateProfile('BACKGROUND','paint',false,path)~=0


CATEGORY={
  'news',
  'sports',
  'information',
  'drama',
  'music',
  'variety',
  'movie',
  'anime',
  'documentary',
  'theater',
  'education',
  'welfare',
  'extension',
  'extension',
  'extension',
  'other',
}

tab=0+(mg.get_var(mg.request_info.query_string,'tab') or 0)
page=0+(mg.get_var(mg.request_info.query_string,'page') or 0)
date=0+(mg.get_var(mg.request_info.query_string,'date') or 0)
hour=0+(mg.get_var(mg.request_info.query_string,'hour') or 0)
--hour=0で現在時刻-MARGIN_HOUR時間を基準、0以外で"hour"時を基準

adjust=math.floor(hour/24)
date=(hour~=24 and date+adjust or date)
hour=(hour~=24 and hour-adjust*24 or hour)

now=os.time()
timezone=os.time(os.date('*t',now))-os.time(os.date('!*t',now))
nowDate=math.floor((now+timezone)/(24*3600))
nowHour=math.floor(((now+timezone)-nowDate*24*3600)/3600)
baseHour=(hour==0 and nowHour-MARGIN_HOUR or hour)
baseHour=(baseHour<0 and baseHour+24 or baseHour)
baseDate=math.floor((now+timezone-baseHour*3600)/(24*3600))
baseDate=(hour>nowHour and baseDate+1 or baseDate)
baseTime=baseDate*24*3600+baseHour*3600-timezone

ct=[=[
<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1.5">
<title>EpgTimer</title>
<link rel="shortcut icon" href="img/EpgTimer.ico">
<link href="css/default.css" rel="stylesheet" type="text/css">
<style type="text/css">
<!--
]=]

ct=ct..'html,body{background:'..background..';}\n'
  ..'[class^="id"]{width:'..w_service..'px;}#hour{width:'..w_hour..'px;}\n'
  ..'.news{background:'..news
  ..';}.sports{background:'..sports
  ..';}.information{background:'..information
  ..';}.drama{background:'..drama
  ..';}.music{background:'..music
  ..';}.variety{background:'..variety
  ..';}.movie{background:'..movie
  ..';}.anime{background:'..anime
  ..';}.documentary{background:'..documentary
  ..';}.theater{background:'..theater
  ..';}.education{background:'..education
  ..';}.welfare{background:'..welfare
  ..';}.extension{background:'..extension
  ..';}.other{background:'..other
  ..';}.none{background:'..none
  ..';}.nothing{background:'..nothing
  ..';}\n'

  ..'.reserved{'..(paint and 'border:none;background:' or 'border-color:')..reserved..';}'
  ..'.disable{'..(paint and 'border:none;background:' or 'border-color:')..disable..';}'
  ..'.partially{background:'..partially..';border-color:'..partially_border..';}'
  ..'.shortage{background:'..shortage..';border-color:'..shortage_border..';}\n'

count=0+edcb.GetPrivateProfile('HIDE','count',0,path)

hidelist={}
if count>0 then
  for i=0,count do
    v=edcb.GetPrivateProfile('HIDE','hide'..i,0,path)
    hide=(hide and hide..',' or '')..'.id-'..v
    m={string.match(v, '^(%d+)%-(%d+)%-(%d+)$')}
    if #m==3 then
    b={
    onid=0+m[1],
    tsid=0+m[2],
    sid=0+m[3]
    }
    table.insert(hidelist,b)
    end
  end
  ct=ct..hide..'{display:none;}\n'
end

ct=ct..'@media screen and (max-width:720px){[class^="id"]{width:'..w_service_sp..'px;}#hour{width:'..w_hour_sp..'px;}}\n'

ct=ct..[=[
--> 
</style>
<script src="js/jquery.min.js"></script>
<script src="js/tvguide.js"></script>
<script type="text/javascript">
]=]
ct=ct..'oneminpx='..ONE_MIN_PX..';\n'
     ..'basehour='..baseHour..';\n'
     ..'marginmin='..MARGIN_MIN..';\n'
     ..'hover='..(hover and 'true' or 'false')..';\n'

ct=ct..(date == 0 and hour==0 and '$(window).load(function(){jump();});\n' or '')

edcb.htmlEscape=15
a=edcb.GetServiceList()
sort={}
count=0+edcb.GetPrivateProfile('SORT','count',0,path)
if count>0 then
  for i=0,count do
    w=edcb.GetPrivateProfile('SORT','sort'..i,0,path)
    m={string.match(w, '^(%d+)%-(%d+)%-(%d+)$')}
    if #m==3 then
    onid=0+m[1]
    tsid=0+m[2]
    sid=0+m[3]
    end
    for i,v in ipairs(a or {}) do
      if onid==v.onid and tsid==v.tsid and sid==v.sid then
        table.insert(sort, v)
        break
      end
    end
  end
else
  sort=a
  if (tab==0) then
    table.sort(sort, function(a,b) return a.remote_control_key_id<b.remote_control_key_id end)
  else
    table.sort(sort, function(a,b) return a.sid<b.sid end)
  end
end

ct=ct..[=[
</script>
</head>
<body>

<div id="wrap">
<div id="tvheader">
<div id="menu">
<div id="menu_ico"><span></span></div>
<div class="menu">
<span>番組表</span>
<div class="space"></div>
<nav>
<a href="reserve.html">予約一覧</a>
<a href="autoaddepg.html">EPG予約</a>
<a class="sp" href="recinfo.html">録画結果</a>
<a href="search.html">検索</a>
</nav>
</div>
</div>
]=]

rt={}
for i,v in ipairs(edcb.GetReserveData()) do
  rt[string.format('%04X%04X%04X%04X', v.onid, v.tsid, v.sid, v.eid)]=v.reserveID
end

minTime=nil
maxTime=nil
st={}
for i,v in ipairs(sort or {}) do
  if (v.partialReceptionFlag or v.service_type==0x01 or v.service_type==0xA5 or v.service_type==0xAD) and (
     tab==0 and 0x7880<=v.onid and v.onid<=0x7FE8 and v.service_type==0x01 or
     tab==1 and v.partialReceptionFlag or
     tab==2 and v.onid==4 or
     tab==3 and (v.onid==6 or v.onid==7) or
     tab==4 and v.onid~=4 and v.onid~=6 and v.onid~=7 and (v.onid<0x7880 or 0x7FE8<v.onid)) then
    table.insert(st, v)
    st[#st].et={}
    b=edcb.EnumEventInfo({{onid=v.onid, tsid=v.tsid, sid=v.sid}})
    for j,w in ipairs(b or {}) do
      if w.startTime then
        startTime=os.time(w.startTime)
        endTime=w.durationSecond and startTime+w.durationSecond or (j<#b and os.time(b[j+1].startTime) or startTime)
        minTime=minTime and startTime>minTime and minTime or startTime
        maxTime=maxTime and startTime<maxTime and maxTime or startTime
        if baseTime+date*24*3600<=endTime and startTime<baseTime+((date+1)*24+1)*3600 then
          table.insert(st[#st].et, w)
        end
      end
    end
    table.sort(st[#st].et, function(a,b) return os.time(a.startTime)<os.time(b.startTime) end)
  end
end

ct=ct..'<div id="submenu"><ul>\n'

ct=ct..'<li class="now dividers"><a '..(date==0 and 'class="jumpnow"' or 'href="epg.html?tab='..tab..'&date=0"')..'><span></span></a></li>\n'

pu='<li class="pull tabpage dividers"><a>'..(tab==0 and '地デジ' or tab==1 and 'ワンセグ' or tab==2 and 'BS' or tab==3 and 'CS' or tab==4 and 'その他' or '')..'</a>\n<ul class="jump">\n'
se='<li class="select dividers"><select name="tabpage" onchange="location.href=value;">\n'

u='="epg.html?tab=0&date='..date..(hour~=0 and '&hour='..hour or date~=0 and '&hour=4' or '')..'">'
pu=pu..'<li><a'..(tab==0 and ' class="active">' or ' href'..u)..'地デジ</a></li>\n'
se=se..'<option' ..(tab==0 and ' selected>' or ' value'..u)..'地デジ</option>\n'
if oneseg then
  u='="epg.html?tab=1&date='..date..(hour~=0 and '&hour='..hour or date~=0 and '&hour=4' or '')..'">'
  pu=pu..'<li><a'..(tab==1 and ' class="active">' or ' href'..u)..'ワンセグ</a></li>\n'
  se=se..'<option' ..(tab==1 and ' selected>' or ' value'..u)..'ワンセグ</option>\n'
end
u='="epg.html?tab=2&date='..date..(hour~=0 and '&hour='..hour or date~=0 and '&hour=4' or '')..'">'
pu=pu..'<li><a'..(tab==2 and ' class="active">' or ' href'..u)..'BS</a></li>\n'
se=se..'<option' ..(tab==2 and ' selected>' or ' value'..u)..'BS</option>\n'
u='="epg.html?tab=3&date='..date..(hour~=0 and '&hour='..hour or date~=0 and '&hour=4' or '')..'">'
pu=pu..'<li><a'..(tab==3 and ' class="active">' or ' href'..u)..'CS</a></li>\n'
se=se..'<option' ..(tab==3 and ' selected>' or ' value'..u)..'CS</option>\n'
u='="epg.html?tab=4&date='..date..(hour~=0 and '&hour='..hour or date~=0 and '&hour=4' or '')..'">'
pu=pu..'<li><a'..(tab==4 and ' class="active">' or ' href'..u)..'その他</a></li>\n'
se=se..'<option' ..(tab==4 and ' selected>' or ' value'..u)..'その他</option>\n'

pu=pu..'</ul></li>\n'
se=se..'</select></li>\n'
ct=ct..pu..se

if minTime then
    t=(hour==0 and baseHour+MARGIN_HOUR>24 and 1 or hour==24 and 1 or 0)
    d=os.date('*t', (date+baseDate+t)*24*3600-timezone)
    d=d.month..'/'..d.day..'('..({'日','月','火','水','木','金','土'})[d.wday]..')'
  pu='<li class="pull date"><a>'..d..'</a><ul class="jump">\n'
  se='<li class="select"><select name="date" onchange="location.href=value;">\n'

  mindate=math.floor((minTime+timezone-(date~=0 and hour<nowHour and baseHour*3600 or 0))/(24*3600))
  maxdate=math.floor((maxTime+timezone-baseHour*3600)/(24*3600))

  for i=mindate,maxdate do
    d=os.date('*t', i*24*3600-timezone)
    d=d.month..'/'..d.day..'('..({'日','月','火','水','木','金','土'})[d.wday]..')<'
    u='="epg.html?tab='..tab..'&date='..(i-baseDate-t)..(i-baseDate-t==0 and '' or hour~=0 and '&hour='..hour or '&hour=4')..'">'

    pu=pu..'<li><a'..(i-baseDate-t==date and ' class="active">' or ' href'..u)..d..'/a></li>\n'
    se=se..'<option'..(i-baseDate-t==date and ' selected>' or ' value'..u)..d..'/option>\n'
  end
  pu=pu..'</ul></li>\n'
  se=se..'</select></li>\n'
  ct=ct..'<li class="navi"><a class="prev'..(date<=mindate-baseDate-t and ' disabled"' or '" href="epg.html?tab='..tab..'&date='..(date-1)..'&hour='..hour..'"')..'></a></li>'
       ..pu..se
       ..'<li class="navi dividers"><a class="next'..(date>=maxdate-baseDate-t and ' disabled"' or '" href="epg.html?tab='..tab..'&date='..(date+1)..'&hour='..hour..'"')..'></a></li>'

  pu='<li class="pull time"><a>時間</a><ul class="jump">\n'
  se='<li class="select"><select name="time">\n<option>時間</option>\n'
  k=1
  for i=baseHour , baseHour+23 ,2 do
    j=(i>27 and i-24 or i)
    u=' value="'..k..'">'..j..'時<'
    pu=pu..'<li><a'..u..'/a></li>\n'
    se=se..'<option'..u..'/option>\n'
    k=k+2
  end

  pu=pu..'</ul></li>\n'
  se=se..'</select></li>\n'
  ct=ct..pu..se
end

ct=ct..'</ul></div>\n</div>\n\n'

ct=ct..[=[
<div class="sidemenu">
<span class="title">EpgTimer</span>
<nav>
<span class="link toggle">サービス</span>
<ul id="service-list">
]=]

  for i,v in ipairs(st) do
    hide=nil
    for j,w in ipairs(hidelist) do
      if w.onid==v.onid and w.tsid==v.tsid and w.sid==v.sid then
        hide=true
        break
      end
    end
    if (v.partialReceptionFlag or v.service_type==0x01 or v.service_type==0xA5) then
      ct=ct..'<li><input id="c-'..v.onid..'-'..v.tsid..'-'..v.sid..'" type="checkbox" name="hide" value="'..v.onid..'-'..v.tsid..'-'..v.sid..'"'..(hide and ' checked="checked"' or '')..'><label class="switch reverse" for="c-'..v.onid..'-'..v.tsid..'-'..v.sid..'"></label><label for="c-'..v.onid..'-'..v.tsid..'-'..v.sid..'">'..v.service_name..'</label></li>\n'
    end
  end

ct=ct..'</ul>\n'
     ..'<span class="link toggle">ジャンル</span>\n'
     ..'<ul id="genre-list">\n'

  for i=0,15 do
    nibble1=edcb.GetGenreName(i*256+255)
    if nibble1~='' then
      ct=ct..'<li><label id="g-'..(i*256+255)..'" for="g-'..(i*256+255)..'" data-value="'..CATEGORY[i+1]..'">'..nibble1..'</label></li>\n'
    end
  end
ct=ct..[=[
</ul>
<div class="separator"></div>
<a class="link" href="epg.html">番組表</a>
<a class="link" href="reserve.html">予約一覧</a>
<a class="link" href="tunerreserve.html">チューナー別</a>
<a class="link" href="autoaddepg.html">EPG予約</a>
<a class="link" href="recinfo.html">録画結果</a>
<a class="link" href="search.html">検索</a>
<a class="link" href="setting.html">設定</a>
</nav>
</div>
<div class="obfuscator"></div>
]=]

rowHead='<div id="head" class="shadow"><ul>\n'
for i,v in ipairs(st) do
  rowHead=rowHead..'<li class="id-'..v.onid..'-'..v.tsid..'-'..v.sid..'">'..v.service_name..'</li>\n'
end
rowHead=rowHead..'</ul></div>\n'

colHead='<div id="wrap_tv_1">\n<div id="hour">\n'
for i=baseHour,baseHour+24 do
     j=(i>27 and i-24 or i)
  colHead=colHead..'<div style="height:'..(ONE_MIN_PX*60)..'px"><p class="t'..j..'">'..j..'時</p></div>\n'
end
colHead=colHead..'</div>\n'

ctt={ct}
table.insert(ctt, rowHead..colHead..'<div id="wrap_tv_2">'..(date==0 and '<div id="line"></div>\n' or '')..'<div id="wrap_tv_3"><ul id="tvguide">\n')
for i,v in ipairs(st) do
  table.insert(ctt, '<li class="id-'..v.onid..'-'..v.tsid..'-'..v.sid..'">\n')
  lastPx=0
  total=0
  for j,w in ipairs(v.et) do
    startTime=os.time(w.startTime)
    startPx=math.min(math.floor((startTime-baseTime-date*24*3600)/60)*ONE_MIN_PX, ONE_MIN_PX*60*25)
    endTime=w.durationSecond and startTime+w.durationSecond or (j<#v.et and os.time(v.et[j+1].startTime) or startTime) --終了時間未定
    endPx=math.min(math.floor((endTime-baseTime-date*24*3600)/60)*ONE_MIN_PX, ONE_MIN_PX*60*25)
    if startPx-lastPx>0 then
      table.insert(ctt, '<div class="cell'..os.date(' %d-%H-%M', startTime)..'" style="height:'..(startPx-lastPx)..'px"><div class="content nothing"></div><div class="end'..(startTime-now<=0 and ' mask' or '')..'" style="height:'..(startPx-lastPx-2)..'px"></div></div>\n')
      total=total+startPx-lastPx
      lastPx=startPx
    end
    if endPx-lastPx>2 then
      category=w.contentInfoList and #w.contentInfoList>0 and CATEGORY[math.floor(w.contentInfoList[1].content_nibble/256)%16+1] or 'none'	--背景色
      title=(w.shortInfo and ConvertTitle(w.shortInfo.event_name) or '')									--番組タイトル
      info=string.gsub((w.shortInfo and '<p>'..w.shortInfo.text_char..'</p>' or ''), '\r?\n', '<br>')						--番組詳細
      search=(w.shortInfo and ConvertSearch(w.shortInfo.event_name) or '')									--検索

      r=nil
      id=rt[string.format('%04X%04X%04X%04X', w.onid, w.tsid, w.sid, w.eid)]
      if id then
        r=edcb.GetReserveData(id)
      end
      rs=r and r.recSetting or nil

      time='<li class="start"><span>'..os.date('%M', startTime)..'</span>'									--開始時間
        ..(r and '<span class="mark recable'..(rs.recMode==5 and ' no">無' or r.overlapMode==1 and '">部' or r.overlapMode==2 and '">不'  or '">録')..'</span>' or '')..'</li>'	--録画マーク
      recmode=r and (rs.recMode==5 and ' disable' or r.overlapMode==1 and ' partially' or r.overlapMode==2 and ' shortage' or ' reserved') or ''	--録画モード
      reURL='tab='..tab..'&date='..date..(hour~=0 and '&hour='..hour or '')
      idURL='onid='..w.onid..'&tsid='..w.tsid..'&sid='..w.sid..'&eid='..w.eid

      table.insert(ctt, '<div class="cell'..(endTime~=startTime and os.date(' %d-%H-%M', endTime) or '')..'" style="height:'..(endPx-lastPx)..'px'
        ..'">\n<div class="content '..category..recmode..'"><ul>'..time
        ..'<li>'..title..(w.durationSecond and w.durationSecond>=30*60 and info or '') 
        ..'</li></ul></div>\n'

        ..'<div class="popup '..category..recmode..'" style="min-height:'..(endPx-lastPx)..'px"><ul>'..time
        ..'<li>'..title..info..search
        ..'<ul class="tool"><li><a class="button raised" href=\"epginfo.html?onid='..w.onid..'&tsid='..w.tsid..'&sid='..w.sid..'&eid='..w.eid..'&tab='..tab..'&date='..date..(hour~=0 and '&hour='..hour or '')..'">番組詳細</a></li>'
        ..(endTime~=startTime and endTime-now>0 and '<li class="reserve"><label class="button raised"'								--終了前
        ..(r and ' data-reserve="'..id..'">'..(rs.recMode==5 and '有効' or '無効')		--予約あり有効無効
          or 'data-onid="'..w.onid..'" data-tsid="'..w.tsid..'" data-sid="'..w.sid..'" data-eid="'..w.eid..'">録画予約')..'</label></li>' or '')			--なし新規追加
        ..'</ul>'
        ..string.gsub(string.gsub((w.extInfo and '<p>'..w.extInfo.text_char..'</p>' or ''), 'https?://[%w/:%#%$&%?%(%)~%.=%+%-_]+', '<a href="%1" target="_blank">%1</a>'), '\r?\n', '<br>')
        ..'</li></ul></div>\n'
        ..'<div class="end'..(endTime~=startTime and endTime-now<0 and ' mask' or '')..'" style="height:'..(endPx-lastPx-2)..'px"></div></div>\n\n')
      total=total+endPx-lastPx
      lastPx=endPx
    end
  end
  if total<25*60*ONE_MIN_PX then
    table.insert(ctt, '<div class="cell" style="height:'..(25*60*ONE_MIN_PX-total)..'px"><div class="content nothing"></div></div>\n')
  end
  table.insert(ctt, '</li>\n')
end

table.insert(ctt, '</ul></div></div>\n')

table.insert(ctt,[=[
</div>
</div>
</boby>
</html>
]=])

cl=0
for i,v in ipairs(ctt) do cl=cl+#v end
mg.write('HTTP/1.1 200 OK\r\nContent-Type: text/html\r\nContent-Length: '..cl..(mg.keep_alive(true) and '' or '\r\nConnection: close')..'\r\n\r\n')
for i,v in ipairs(ctt) do mg.write(v) end
