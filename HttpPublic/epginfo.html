dofile(mg.document_root..'\\util.lua')

ct=[=[
<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1.5">
<title>EpgTimer</title>
<link rel="shortcut icon" href="img/EpgTimer.ico">
<link href="css/default.css" rel="stylesheet" type="text/css">
<script src="js/jquery.min.js"></script>
<script src="js/common.js"></script>
</head>
<body>
<div id="wrap">
<div id="wrap2">
<div id="header" class="shadow">
<div id="menu">
<div id="menu_ico"><span></span></div>
<div class="menu">
<span>番組情報</span>
<div class="space"></div>
<nav>
<a href="epg.html">番組表</a>
<a href="reserve.html">予約一覧</a>
<a class="sp" href="autoaddepg.html">EPG予約</a>
<a class="sp" href="recinfo.html">録画結果</a>
<a href="search.html">検索</a>
</nav>
</div>
</div>
</div>
<div class="sidemenu">
<span class="title">EpgTimer</span>
<nav>
<a class="link" href="epg.html">番組表</a>
<a class="link" href="reserve.html">予約一覧</a>
<a class="link" href="tunerreserve.html">チューナー別</a>
<a class="link" href="autoaddepg.html">EPG予約</a>
<a class="link" href="recinfo.html">録画結果</a>
<a class="link" href="search.html">検索</a>
<a class="link" href="setting.html">設定</a>
</nav>
</div>
<div class="obfuscator"></div>
<div id="main">
<div class="center">
]=]

onid=0+(mg.get_var(mg.request_info.query_string,'onid') or 0)
tsid=0+(mg.get_var(mg.request_info.query_string,'tsid') or 0)
sid=0+(mg.get_var(mg.request_info.query_string,'sid') or 0)
eid=0+(mg.get_var(mg.request_info.query_string,'eid') or 0)
presetID=0+(mg.get_var(mg.request_info.query_string,'presetID') or 65535)
tab=0+(mg.get_var(mg.request_info.query_string,'tab') or 0)
page=0+(mg.get_var(mg.request_info.query_string,'page') or 0)
date=0+(mg.get_var(mg.request_info.query_string,'date') or 0)
hour=0+(mg.get_var(mg.request_info.query_string,'hour') or 0)
dataID=0+(mg.get_var(mg.request_info.query_string, 'id') or 0)

if mg.get_var(mg.request_info.query_string,'search') then
  if dataID~=0 then
    val='&dataid='..dataID
  else
    network=0
    for i=0,10000 do
      v=mg.get_var(mg.request_info.query_string, 'network', i)
      if not v then break end
      network=network+v
    end
    for i=0,10000 do
      v=mg.get_var(mg.request_info.query_string, 'contentList', i)
      if not v then break end
      con=(con and con or '')..'&contentList='..v
    end
    for i=0,10000 do
      v=mg.get_var(mg.request_info.query_string, 'serviceList', i)
      if not v then break end
      m={string.match(v, '^(%d+)%-(%d+)%-(%d+)$')}
      if #m==3 then
        ser=(ser and ser or '&service=')..'&serviceList='..v
      end
    end
    val='&search=&andKey='..mg.get_var(mg.request_info.query_string, 'andKey')..'&notKey='..mg.get_var(mg.request_info.query_string, 'notKey')..(mg.get_var(mg.request_info.query_string, 'regExpFlag') and '&regExpFlag=' or '')..(mg.get_var(mg.request_info.query_string, 'aimaiFlag') and '&aimaiFlag=' or '')..(mg.get_var(mg.request_info.query_string, 'titleOnlyFlag') and '&titleOnlyFlag=' or '')..'&network='..network..'&days='..mg.get_var(mg.request_info.query_string, 'days')..(con and con or '')..(ser and ser or '')
  end
end

r=nil
edcb.htmlEscape=15
for i,v in ipairs(edcb.GetReserveData()) do
  if v.onid==onid and v.tsid==tsid and v.sid==sid and v.eid==eid then
    r=v
    break
  end
end
if not r and presetID==65535 then
  presetID=0
end

ct=ct.._ConvertEpgInfoText2(onid, tsid, sid, eid)
  ..'<h2>録画設定</h2>\n<div id="rec" class="card"><div class="form">\n'
  ..'<form id="set" method="POST" action="'
  ..(r and 'reservechg.html?id='..r.reserveID..'&tab='..tab..'&date='..date..(hour~=0 and '&hour='..hour or '')..(mg.get_var(mg.request_info.query_string,'search') and '&search=&page='..page..val or '')
    or 'reserveadd.html?onid='..onid..'&tsid='..tsid..'&sid='..sid..'&eid='..eid..'&tab='..tab..'&date='..date..(hour~=0 and '&hour='..hour or '')..(mg.get_var(mg.request_info.query_string,'search') and '&search=&page='..page..val or ''))
  ..'">\n<div>'
  ..(r and '<input type="hidden" name="id" value="'..r.reserveID..'">\n' or '')
  ..'<ul><li>プリセット</li>\n<li class="select"><select name="presetID">\n'
preset=false
rs=r and r.recSetting or nil
for i,v in ipairs(edcb.EnumRecPresetInfo()) do
  if v.id==presetID then
    preset=true
    rs=v.recSetting
    ct=ct..'<option value="'..v.id..'" selected>'..v.name..'\n'
  else
    ct=ct..'<option value="'..v.id..'">'..v.name..'\n'
  end
end
if r then
  ct=ct..'<option value="65535"'..(preset and '' or ' selected')..'>予約時'
end
  ct=ct..'</select></li></ul>\n'


  ct=ct..RecSettingTemplate(rs)..'</div></form>\n'
  if r then
    ct=ct..'<form id="del" method="POST" action="reservedel.html?id='..r.reserveID..'&tab='..tab..'&date='..date..(hour~=0 and '&hour='..hour or '')..(mg.get_var(mg.request_info.query_string,'search') and '&search=&page='..page..val or '')..'"></form>\n'
  end
  ct=ct..'</div>\n<div id="button"><input class="button" form="set" type="submit" value="'..(r and '変更' or '予約追加')..'">'..(r and '<input form="del" class="button del" type="submit" value="削除">' or '')..'</div>\n'

ct=ct..[=[
</div>
</div>
</div>
</div>
</body>
</html>
]=]
mg.write('HTTP/1.1 200 OK\r\nContent-Type: text/html\r\nContent-Length: '..#ct..(mg.keep_alive(true) and '' or '\r\nConnection: close')..'\r\n\r\n', ct)
