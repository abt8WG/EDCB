dofile(mg.document_root..'\\string.lua')
PAGE_COUNT=30
ct=[=[
<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1.5">
<title>EpgTimer</title>
<link rel="shortcut icon" href="img/EpgTimer.ico">
<link href="css/default.css" rel="stylesheet" type="text/css">
<script src="js/jquery.min.js"></script>
<script src="js/common.js"></script>
</head>
<body>
<div id="wrap">
<div id="wrap2">
<div id="header" class="shadow">
<div id="menu">
<div id="menu_ico"><span></span></div>
<div class="menu">
<span>検索</span>
<div class="space"></div>
<nav>
<a href="epg.html">番組表</a>
<a href="reserve.html">予約一覧</a>
<a href="autoaddepg.html">EPG予約</a>
<a class="sp" href="recinfo.html">録画結果</a>
</nav>
</div>
</div>
</div>
<div class="sidemenu">
<span class="title">EpgTimer</span>
<nav>
<a class="link" href="epg.html">番組表</a>
<a class="link" href="reserve.html">予約一覧</a>
<a class="link" href="tunerreserve.html">チューナー別</a>
<a class="link" href="autoaddepg.html">EPG予約</a>
<a class="link" href="recinfo.html">録画結果</a>
<a class="link" href="search.html">検索</a>
<a class="link" href="setting.html">設定</a>
</nav>
</div>
<div class="obfuscator"></div><div id="main">
]=]
edcb.htmlEscape=15

dataID=0+(mg.get_var(mg.request_info.query_string, 'id') or 0)

if dataID~=0 then
  for i,v in ipairs(edcb.EnumAutoAdd()) do
    if v.dataID==dataID then
      key=v.searchInfo
      key.days=0
      key.network=0
      key.andKey=string.gsub(key.andKey, '^%^%!{999}(.+)', '%1')
      break
    end
  end
end


if not key then
  key={
    andKey=mg.get_var(mg.request_info.query_string, 'andKey') or '',
    notKey=mg.get_var(mg.request_info.query_string, 'notKey') or '',
    regExpFlag=mg.get_var(mg.request_info.query_string, 'regExpFlag') or false,
    aimaiFlag=mg.get_var(mg.request_info.query_string, 'aimaiFlag') or false,
    titleOnlyFlag=mg.get_var(mg.request_info.query_string, 'titleOnlyFlag') or false,
    network=0,
    days=mg.get_var(mg.request_info.query_string, 'days') or 0,
    days29=mg.get_var(mg.request_info.query_string, 'days29') or 0,
    contentList={},
    serviceList={}
  }

  for i=0,10000 do
    v=mg.get_var(mg.request_info.query_string, 'network', i)
    if not v then break end
    key.network=key.network+v
  end

  for i=0,10000 do
    v=mg.get_var(mg.request_info.query_string, 'contentList', i)
    if not v then break end
    table.insert(key.contentList, {content_nibble=0+v})
    con=(con and con or '')..'&contentList='..v
  end

  if mg.get_var(mg.request_info.query_string, 'service') then
    for i=0,10000 do
      v=mg.get_var(mg.request_info.query_string, 'serviceList', i)
      if not v then break end
      m={string.match(v, '^(%d+)%-(%d+)%-(%d+)$')}
      if #m==3 then
        table.insert(key.serviceList, {onid=0+m[1], tsid=0+m[2], sid=0+m[3]})
        ser=(ser and ser or '&service=')..'&serviceList='..v
      end
    end
  else
    for j,w in ipairs(edcb.GetChDataList()) do
      if w.searchFlag then
        table.insert(key.serviceList, w)
      end
    end
  end
end

b=edcb.SearchEpg(key)
table.sort(b, function(a,b) return os.time(a.startTime) < os.time(b.startTime) end)

a={}

for i,v in ipairs(b or {}) do
  if v.startTime then
    startTime=os.time(v.startTime)
    endTime=v.durationSecond and startTime+v.durationSecond or startTime
    if os.time()<=endTime then
      table.insert(a, v)
    end
  end
end

pageIndex=0+(mg.get_var(mg.request_info.query_string,'page') or 0)

ct=ct..'<div id="rec" class="center card"><div class="form">\n'
  ..'<form id="search" method="GET" action="search.html"><div class="sp">\n'
  ..'<ul><li>検索キーワード</li><li><input type="text" name="andKey" value="'..key.andKey..'" size="25"></li></ul>\n'
  ..'<ul class="bottom"><li>NOTキーワード</li><li><input type="text" name="notKey" value="'..key.notKey..'" size="25"></li></ul>\n'
  ..'<ul><li></li><li class="float"><input id="reg" type="checkbox" name="regExpFlag"'..(key.regExpFlag and ' checked="checked"' or '')..'><label class="checkbox" for="reg">正規表現</label></li>'
  ..'<li><input id="aimai" type="checkbox" name="aimaiFlag"'..(key.aimaiFlag and ' checked="checked"' or '')..'><label class="checkbox" for="aimai">あいまい検索</label></li>'
  ..'<li><input id="title" type="checkbox" name="titleOnlyFlag"'..(key.titleOnlyFlag and ' checked="checked"' or '')..'><label class="checkbox" for="title">番組名のみ</label></li></ul>\n'
  ..'<ul class="check btn"><li>対象ジャンル</li><li><ul><li class="multiple sp"><select id="content2" name="contentList" multiple size="5">\n'
  for i=0,15 do
    nibble1=edcb.GetGenreName(i*256+255)
    if nibble1~='' then
      ct=ct..'<option class="g'..(i*256+255)..'" value="'..(i*256+255)..'"'
      for j,v in ipairs(key.contentList) do
        if v.content_nibble==i*256+255 then
          ct=ct..' selected'
          break
        end
      end
      ct=ct..'>'..nibble1..'</option>\n'
    end
  end
ct=ct..'</select></li><li class="sp"><input id="g_celar" class="button raised" type="button" value="クリア"></li></ul></li></ul>\n'
--[=[
  ..'<ul><li>対象ネットワーク</li><li class="float"><input id="DTV" type="checkbox" name="network" value="1"'..(bit32.band(key.network,1)==1 and ' checked="checked"' or '')..'><label for="DTV">地上波</label></li>'
  ..'<li><input id="BS" type="checkbox" name="network" value="2"'..(bit32.band(key.network,2)==2 and ' checked="checked"' or '')..'><label for="BS">BS</label></li>'
  ..'<li class="float"><input id="CS" type="checkbox" name="network" value="4"'..(bit32.band(key.network,4)==4 and ' checked="checked"' or '')..'><label for="CS">CS</label></li>'
  ..'<li><input id="other" type="checkbox" name="network" value="8"'..(bit32.band(key.network,8)==8 and ' checked="checked"' or '')..'><label for="other">その他</label></li></ul>\n'
--]=]
  ..'<input type="hidden" name="service">\n'
  ..'<ul class="check bottom btn"><li>対象サービス</li><li><ul><li class="select"><select id="service">\n'
  ..'<option value="all">すべて表示</option>\n'
  ..'<option value="DTV">地デジ</option>\n'
  ..'<option value="SEG">ワンセグ</option>\n'
  ..'<option value="BS">BS</option>\n'
  ..'<option value="CS">CS</option>\n'
  ..'<!--\n<option value="HD">スカパーHD</option>\n'
  ..'<option value="SD">スカパーSD</option>\n'
  ..'<option value="other">その他</option>\n-->\n'
  ..'</select></li><li class="sp"><input id="s_all" class="button raised" type="button" value="全選択"></li></ul></li></ul>\n'
   ..'<ul class="check"><li></li><li class="multiple"><select id="service2" name="serviceList" multiple size="5">\n'

  c=edcb.GetChDataList()
  st={}
  table.sort(c, function(a,b) return a.sid<b.sid end)
  for i,v in ipairs(c or {}) do
    if 0x7880<=v.onid and v.onid<=0x7FE8 then
      table.insert(st, v)
    end
  end
  for i,v in ipairs(c or {}) do
    if (v.onid<0x7880 or 0x7FE8<v.onid) then
      table.insert(st, v)
    end
  end

  for i,v in ipairs(st) do
    if v.serviceType==0x01 or v.partialFlag then
      ct=ct..'<option class="'..(
        v.onid==4 and 'BS' or
        (v.onid==6 or v.onid==7) and 'CS' or
        v.onid==10 and 'HD' or
        (v.onid==1 or v.onid==3) and 'SD' or
        (0x7880<=v.onid and v.onid<=0x7FE8) and (v.partialFlag and "SEG" or 'DTV') or 'other')
      ..'" value="'..v.onid..'-'..v.tsid..'-'..v.sid..'"'
      for j,w in ipairs(key.serviceList) do
        if w.onid==v.onid and w.tsid==v.tsid and w.sid==v.sid then
          ct=ct..' selected'
          break
        end
      end
      ct=ct..'>'..v.serviceName..'</option>\n'
    end
  end
ct=ct..'</select></li></ul>\n'
  ..'<ul><li>対象期間</li><li class="sp"><input type="number" name="days" value="'..key.days..'" min="0">×24時間以内 <small>※0で無期限</small></li></ul>\n'
  ..'</div></form>\n'
  ..'</div>\n<div id="button"><input class="button" form="search" type="submit" value="検索"></div>\n</div>\n'

if #a>0 then


  val='andKey='..key.andKey..'&notKey='..key.notKey..(key.regExpFlag and '&regExpFlag=' or '')..(key.aimaiFlag and '&aimaiFlag=' or '')..(key.titleOnlyFlag and '&titleOnlyFlag=' or '')..'&network='..key.network..'&days='..key.days..(con and con or '')..(ser and ser or '')


  pg='<div class = "page"><ul>\n'
  pg=pg..'<li>'..(pageIndex>0 and '<a class="prev firstpage" href=\"search.html?page=0&'..(dataID~=0 and 'id='..dataID or val)..'"></a>' or '<a class="prev firstpage disabled"></a>')..'</li>\n'
  pg=pg..'<li>'..(pageIndex>0 and '<a class="prev" href=\"search.html?page='..(pageIndex-1)..'&'..(dataID~=0 and 'id='..dataID or val)..'"></a>' or '<a class="prev disabled"></a>')..'</li>\n'

  for i=(pageIndex-2),(pageIndex+2) do
    pg=pg..(i>=0 and i<#a/PAGE_COUNT and (i==pageIndex and '<li class="activepage"><span>'..(i+1)..'</span></li>\n' or '<li><a href=\"search.html?page='..(i)..'&'..(dataID~=0 and 'id='..dataID or val)..'">'..(i+1)..'</a></li>\n') or '')
  end

  pg=pg..'<li>'..(pageIndex<(#a/PAGE_COUNT-1) and '<a  class="next" href=\"search.html?page='..(pageIndex+1)..'&'..(dataID~=0 and 'id='..dataID or val)..'"></a>' or '<a class="next disabled"></a>')..'</li>\n'
  pg=pg..'<li>'..(pageIndex<(#a/PAGE_COUNT-1) and '<a  class="next lastpage" href=\"search.html?page='..math.ceil(#a/PAGE_COUNT-1)..'&'..(dataID~=0 and 'id='..dataID or val)..'"></a>' or '<a class="next lastpage disabled"></a>')..'</li>\n'
  pg=pg..'</ul></div>\n'

  ct=ct..pg..'<div id="list">'
       ..'<table id="reserve">\n'
       ..'<caption>'..#a..' 件中 '..math.max(1,pageIndex*PAGE_COUNT+1)..' － '..math.min(#a,(pageIndex+1)*PAGE_COUNT)..' 件</caption>'

  ct=ct..'<tr class=header>'
       ..'<td class="flag">録画</td>'
       ..'<td class="date">日付</td>'
       ..'<td class="title">番組名</td>'
       ..'<td class="service">サービス</td>'
       ..'<td class="info">番組内容</td>'
       ..'</tr>\n'

  rt={}
  for i,v in ipairs(edcb.GetReserveData()) do
    rt[string.format('%04X%04X%04X%04X', v.onid, v.tsid, v.sid, v.eid)]=true
  end

  ctt={}
  for i=math.max(1,pageIndex*PAGE_COUNT+1),math.min(#a,(pageIndex+1)*PAGE_COUNT) do
    v=a[i]
    for j,w in ipairs(edcb.GetServiceList() or {}) do
      if w.onid==v.onid and w.tsid==v.tsid and w.sid==v.sid then
        service_name=w.service_name
        break
      end
    end
    r=nil
    for j,w in ipairs(edcb.GetReserveData()) do
      if w.onid==v.onid and w.tsid==v.tsid and w.sid==v.sid and w.eid==v.eid then
        id=w.reserveID
        r=edcb.GetReserveData(id)
        break
      end
    end
    rs=r and r.recSetting or nil
    recset=(rt[string.format('%04X%04X%04X%04X', v.onid, v.tsid, v.sid, v.eid)] and (os.time(v.startTime)-os.time()<0 and rs.recMode~=5 and '' or 'data-reserve="'..id..'"') or 'data-onid="'..v.onid..'" data-tsid="'..v.tsid..'" data-sid="'..v.sid..'" data-eid="'..v.eid..'"')
    recmode=(rt[string.format('%04X%04X%04X%04X', v.onid, v.tsid, v.sid, v.eid)] and (os.time(v.startTime)-os.time()>0 and 'switch'..(rs.recMode==5 and '' or ' on') or 'rec '..(rs.recMode==5 and 'not' or 'recording')) or 'rec addrec')


    table.insert(ctt, '<tr data-href="epginfo.html?onid='..v.onid..'&tsid='..v.tsid..'&sid='..v.sid..'&eid='..v.eid..'&search=&'..(dataID~=0 and 'id='..dataID or val)..'&page='..pageIndex..'">'
      ..'<td class="flag"><span class="'..recmode..'"'..recset..'></span></td>'
      ..'<td class="date">'..os.date('%Y/%m/%d('..({'日','月','火','水','木','金','土'})[os.date('%w', os.time(v.startTime))+1]..') %H:%M', os.time(v.startTime))--..os.date('%H:%M', os.time(v.startTime)+v.durationSecond)
      ..'</td><td class="title">'..(v.shortInfo and ConvertTitle(v.shortInfo.event_name) or '')
      ..'</td><td class="service">'..service_name
      ..'</td><td class="info">'..(v.shortInfo and v.shortInfo.text_char or '')
      ..'</td></tr>\n')
  end

  ct=ct..table.concat(ctt)..'</table></div>'..pg

end

if dataID==0 and #a>0 then
  ct=ct..'<span id="add" class="new"></span>'
end

ct=ct..[=[
</div>
</div>
</body>
</html>
]=]
mg.write('HTTP/1.1 200 OK\r\nContent-Type: text/html\r\nContent-Length: '..#ct..(mg.keep_alive(true) and '' or '\r\nConnection: close')..'\r\n\r\n', ct)
